/*------------------------------------------------------------------------------------------------------------------------
 * 文件名称：System_Control.c

 * 文件内容：系统控制

 * 文件版本：1.0.0

 * 文件作者：麦特实验室

 * 开发环境：STC8A8K64S4A12@22.1184MHz芯片 & Keil uVision 5 

 * 注    意：
------------------------------------------------------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------------------------------
                                                  加载头文件区
------------------------------------------------------------------------------------------------------------------------*/
#include "Inc_Basic.h"//基本库
#include "System_Task.h"
#include "System_Control.h"
#include "UART.h"
#include "CPU.h"
/*------------------------------------------------------------------------------------------------------------------------
                                                  变量初始化区
------------------------------------------------------------------------------------------------------------------------*/
SystemFlag Sf = {NULL};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
/*------------------------------------------------------------------------------------------------------------------------
 * 函数名称：system_Init

 * 函数功能：系统初始化

 * 输入参数：无

 * 输出参数：无

 * 注    意：无
------------------------------------------------------------------------------------------------------------------------*/
void System_Init()
{
	/*----------------------------------软件初始化---------------------------------------*/
	SP0 = SP - SP_Init_Va;//记录初始栈指针
	RunAppPy = NULL;//设初始优先级
	Task0Time = Task0TimeSize;
	TaskEndAddr = Gma(TaskEnd);//获取TaskSwitch函数指针
	/*----------------------------------硬件初始化---------------------------------------*/
	InterruptTp(TUART1,Tclass4);//将串口1中断优先级设为最高级
	InterruptTp(TTIMER0,Tclass3);//将定时器0中断设为较高级
	System_Timer_Init;//初始化时钟
	#ifdef EnableSerialPortDebugging
	System_UART_Init;//初始化串口
	#endif
	/*----------------------------------任务初始化---------------------------------------*/
	OnTask();//开启多任务
	TaskLoad(Main_AID,Task_Time,Task_Class_L1,NULL,NULL);//创建主进程
	/*------------------------------------系统测试---------------------------------------*/
	TaskLoad(SYS_TEST,Task_Time,Task_Class_L1,SYS_TEST_Time,Start_Test);
	delay_ms(SYS_TEST_Wait_Time);
	if(Sf.SystemOk == OK)
	{
		Uart_Outs(System_OK_UART);//显示提示
	}
	else
	{
		Uart_Outs(System_Error_UART);//显示提示
		while(true);
	}
}
/*------------------------------------------------------------------------------------------------------------------------
 * 函数名称：Start_Test

 * 函数功能：启动测试

 * 输入参数：无

 * 输出参数：无

 * 注    意：无
------------------------------------------------------------------------------------------------------------------------*/
void Start_Test()
{
	Sf.SystemOk = Enable;//表示系统已开启
	Sf.TaskSwitch = Enable;//开启多任务
	TaskRemove(SYS_TEST);
}
/*------------------------------------------------------------------------------------------------------------------------
 * 函数名称：OffTask

 * 函数功能：关闭多任务

 * 输入参数：无

 * 输出参数：无

 * 注    意：无
------------------------------------------------------------------------------------------------------------------------*/
void OffTask()
{
	#ifdef EnableWDT
 	OFFWDT();///关闭看门狗
	#endif
	Sf.TaskSwitch = Disable;//关闭多任务
}
/*------------------------------------------------------------------------------------------------------------------------
 * 函数名称：OnTask

 * 函数功能：开启多任务

 * 输入参数：无

 * 输出参数：无

 * 注    意：无
------------------------------------------------------------------------------------------------------------------------*/
void OnTask()
{
	#ifdef EnableWDT
	TaskLoad(RSTWDT_AID,Task_Time,Task_Class_L1,WDT_SingleCycle_Time,RSTWDT);//创建任务(看门狗系统)
	System_WDT_Init;//看门狗初始化
	#endif
}
/*------------------------------------------------------------------------------------------------------------------------
 * 函数名称：Gma

 * 函数功能：获取函数地址

 * 输入参数：函数名称

 * 输出参数：无

 * 注    意：无
------------------------------------------------------------------------------------------------------------------------*/
u16 Gma(u16 ADD_R0)
{
	return ADD_R0;
}
/*------------------------------------------------------------------------------------------------------------------------
                                                  END
------------------------------------------------------------------------------------------------------------------------*/